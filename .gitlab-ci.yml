# inference-builder/.gitlab-ci.yml
include:
  - local: 'builder/samples/tao/validation/.gitlab-ci.validation.yml'
  - local: 'deploy/.gitlab-ci.deploy.yml'

# Define stages in order of execution
stages:
  - build-builder     # Only runs when build dependencies change
  - build-deployer    # Only runs when deploy dependencies change
  - build-inference   # Generates tao.tgz package
  - build-docker     # Builds and pushes tao container
  - deploy-test       # For each combination: deploy -> validate -> teardown
  - deploy            # Deploys the helm chart to the cluster
  - build-validator   # Builds and pushes validator container

# Global variables used across jobs
variables:
  # GitLab's container registry URL for this project
  BUILDER_IMAGE: ${CI_REGISTRY_IMAGE}/builder:latest
  DEPLOYER_IMAGE: ${CI_REGISTRY_IMAGE}/deployer:latest
  NIM_TAO_IMAGE: ${CI_REGISTRY_IMAGE}/nim-tao:${CI_COMMIT_SHA}
  # Cache pip packages between jobs
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Define when pipeline should run
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

# Build the builder image used for building inference package
# Only runs when requirements.txt or other build deps change
build_builder_image:
  stage: build-builder
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    # Build from root directory
    - docker build -t $BUILDER_IMAGE -f .Dockerfile.builder .
    - docker push $BUILDER_IMAGE
  rules:
    - changes:
        - requirements.txt
        - .Dockerfile.builder
      when: always

# Build the deployer image
build_deployer_image:
  stage: build-deployer
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cd deploy
    - docker build -t $DEPLOYER_IMAGE -f Dockerfile.deployer .
    - docker push $DEPLOYER_IMAGE
  rules:
    - changes:
        - deploy/requirements.deployer.sh
        - deploy/Dockerfile.deployer
      when: always

# Template for building the inference package (tao.tgz)
.build_tao_base_template: &build_tao_base_template
  stage: build-inference
  # Use our custom builder image that has all dependencies
  image: $BUILDER_IMAGE
  script:
    - python builder/main.py builder/samples/tao/ds_${FLAVOR}.yaml
      --server-type ${SERVER_TYPE}
      -a builder/samples/tao/openapi.yaml
      --no-docker
      -o builder/samples/tao
      -t
    - mv builder/samples/tao/tao.tgz builder/samples/tao/tao.${FLAVOR}.${SERVER_TYPE}.tgz
  artifacts:
    paths:
      - builder/samples/tao/tao.${FLAVOR}.${SERVER_TYPE}.tgz
    expire_in: 1 week
  rules:
    - changes:
        - builder/samples/tao/**/*
        - builder/main.py
        - templates/**/*
        - .gitlab-ci.yml
        - "!**/*.md"  # Exclude all markdown files using ! prefix


# NIM package: Basic TAO builds with different validations
build_tao_common_nim:
  <<: *build_tao_base_template
  variables:
    FLAVOR: "tao"
    SERVER_TYPE: "nim"

build_tao_changenet_nim:
  <<: *build_tao_base_template
  variables:
    FLAVOR: "changenet"
    SERVER_TYPE: "nim"

build_tao_gdino_nim:
  <<: *build_tao_base_template
  variables:
    FLAVOR: "gdino"
    SERVER_TYPE: "nim"

# MS package: Basic TAO builds with different validations
build_tao_common_fastapi:
  <<: *build_tao_base_template
  variables:
    FLAVOR: "tao"
    SERVER_TYPE: "fastapi"

build_tao_changenet_fastapi:
  <<: *build_tao_base_template
  variables:
    FLAVOR: "changenet"
    SERVER_TYPE: "fastapi"

build_tao_gdino_fastapi:
  <<: *build_tao_base_template
  variables:
    FLAVOR: "gdino"
    SERVER_TYPE: "fastapi"

# Template for building and pushing the final container (NIM or MS)
.build_docker_template_tao: &build_docker_template_tao
  stage: build-docker
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_TLS_CERTDIR: ""  # Keep this for Docker-in-Docker
  dependencies:
    - build_tao_inference
  script:
    # Check if GITLAB_TOKEN is set
    - |
      if [ -z "${GITLAB_TOKEN}" ]; then
        echo "Error: GITLAB_TOKEN is not set. Please configure it in CI/CD variables."
        exit 1
      fi
    # Login to GitLab container registry
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    # login to nvcr.io
    # - docker login nvcr.io -u '$oauthtoken' -p $NGC_API_KEY
    # Build using docker compose
    - cd builder/samples
    # Copy the specific flavor's tgz file to tao.tgz for Docker build
    - cp tao/tao.${FLAVOR}.${SERVER_TYPE}.tgz tao/tao.tgz
    # tao.tgz is copied in Dockerfile, no need to extract
    - docker compose build --build-arg CACHE_BUSTER="$CI_COMMIT_SHA" ${DOCKER_TARGET}
    # Tag and push to registry
    - docker tag ${DOCKER_TARGET} ${CI_REGISTRY_IMAGE}/${IMAGE_TAG_PREFIX}-${FLAVOR}:${CI_COMMIT_SHA}
    - docker push ${CI_REGISTRY_IMAGE}/${IMAGE_TAG_PREFIX}-${FLAVOR}:${CI_COMMIT_SHA}
  rules:
    # - changes:
    #     - builder/samples/tao/**/*
    #     - builder/main.py
    #     - templates/**/*
    #     - .gitlab-ci.yml
    #
    # - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    #   when: manual
    # - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    #   when: manual
    - when: manual   # Always allow manual trigger
    - when: on_success  # Allow pipeline to continue to next stage
  allow_failure: true  # This makes the job optional for pipeline success


# Docker builds for each flavor as NIM
build_docker_common_nim:
  <<: *build_docker_template_tao
  variables:
    FLAVOR: "tao"
    DOCKER_TARGET: "nim-tao"
    IMAGE_TAG_PREFIX: "nim-tao"
    SERVER_TYPE: "nim"
  dependencies:
    - build_tao_common_nim

build_docker_changenet_nim:
  <<: *build_docker_template_tao
  variables:
    FLAVOR: "changenet"
    DOCKER_TARGET: "nim-tao"
    IMAGE_TAG_PREFIX: "nim-tao"
    SERVER_TYPE: "nim"
  dependencies:
    - build_tao_changenet_nim

build_docker_gdino_nim:
  <<: *build_docker_template_tao
  variables:
    FLAVOR: "gdino"
    DOCKER_TARGET: "nim-tao"
    IMAGE_TAG_PREFIX: "nim-tao"
    SERVER_TYPE: "nim"
  dependencies:
    - build_tao_gdino_nim


# Docker builds for each flavor as MS
build_docker_common_ms:
  <<: *build_docker_template_tao
  variables:
    FLAVOR: "tao"
    DOCKER_TARGET: "tao-cv"
    IMAGE_TAG_PREFIX: "ms-tao"
    SERVER_TYPE: "fastapi"
  dependencies:
    - build_tao_common_fastapi

build_docker_changenet_ms:
  <<: *build_docker_template_tao
  variables:
    FLAVOR: "changenet"
    DOCKER_TARGET: "tao-cv"
    IMAGE_TAG_PREFIX: "ms-tao"
    SERVER_TYPE: "fastapi"
  dependencies:
    - build_tao_changenet_fastapi

build_docker_gdino_ms:
  <<: *build_docker_template_tao
  variables:
    FLAVOR: "gdino"
    DOCKER_TARGET: "tao-cv"
    IMAGE_TAG_PREFIX: "ms-tao"
    SERVER_TYPE: "fastapi"
  dependencies:
    - build_tao_gdino_fastapi

# Cache pip packages between jobs
cache:
  paths:
    - .cache/pip
